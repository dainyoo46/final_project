---
title: "finalproject"
author: "Dain Yoo"
date: "12/2/2020"
output: html_document
---

```{r, include=FALSE}
library(tidyverse) 
library(tidymodels)
library(ggplot2)
```

Task 1. 
weight * 5 = duplicate as much as the whole number

Task 2. Cluster
- don't have to use pca
- just use covariates
- barplot for each covariates for each cluster 
- you can also use parellel coordinate plot, but use average of clusters (so that you have one line for each cluster)


### Unsupervised Learning
### 1. 
#### a) 

I am interested in the effect of anti-terror law enactment on affective polarization. I expect to see rising distrust and dislike between the secular and political Islamists in the region, as the latter is framed by the ruling secular elites as potential threats and extremist. 

To measure affective polarization, I will use the Arab Barometer survey data (2006-2019), specifically focusing on questionnaires on Political Islam, such as “How much do you trust in the Islamic party (i.e. Ennahda, Muslim Brotherhood, Justice and Construction Party or any other major Islamist Movement?)” The respondents choose from 1) A great deal of trust, 2) Quite a lot of trust, 3) Not a lot of trust, and 4) No trust at all. Polarization can be measured by assessing if less people responded with moderate stances (response 2 or 3) after the treatment. 

One problem with the data is that the survey data is not panel data. Each wave of survey consists of 2 or 3 years of aggregate survey responses to various questions related to politics, economy and social aspects.

#### b) 

I use dataset for wave 3 (2012-2014) and 4 (2016-2017) to see how polarization exacerbated in Tunisia and Jordan after 2015, when both countries adopted anti-terror law. It would be worthwhile to compare these two countries with other countries that did not adopt relevant legislation, like Algeria and Lebanon. 

```{r, echo=FALSE}
abv3 <- read.csv("abv3.csv")
abv4 <- read.csv("abv4.csv")

wave_3 <- abv3 %>%
  select(country, q20112) %>%
  filter(!q20112 %in% c("Missing", "Refuse", "Don't know")) %>%
  count(country, q20112)

wave_4 <- abv4 %>%
  select(country, q20112, q201a3) %>%
  filter(!is.na(q20112),
         !is.na(q201a3)) %>%
  count(country, q20112, q201a3) %>%
  filter(!q20112 %in% c("Decline to answer (Do not read)", 
                        "Don't know (Do not read)"),
         !q201a3 %in% c("Decline to answer (Do not read)", 
                        "Don't know (Do not read)"))

# Tunisia
tun3 <- wave_3 %>%
  filter(country == "Tunisia") %>%
  mutate(year = "2012-2014")

tun4 <- wave_4 %>%
  filter(country == "Tunisia") %>%
  mutate(year = "2016-2017") 

tun <- bind_rows(tun3, tun4) %>%
  mutate(q20112 = recode(q20112,
                         "No trust at all" = "I absolutely do not trust it" ,
                        "A great deal of trust" = "I trust it to a great extent" ,
                        "Not very much trust" = "I trust it to a limited extent",
                        "Quite a lot of trust" = "I trust it to a medium extent")) %>%
  mutate(q20112 = fct_relevel(q20112, 
                              c("I trust it to a great extent",
                                "I trust it to a medium extent",
                                "I trust it to a limited extent",
                                "I absolutely do not trust it")))


# Jordan
jor3 <- wave_3 %>%
  filter(country == "Jordan") %>%
  mutate(year = "2012-2014")

jor4 <- wave_4 %>%
  filter(country == "Jordan") %>%
  mutate(year = "2016-2017") %>%
  select(-q20112) %>%
  slice(-1) %>%
  rename(q20112 = q201a3)

jor <- bind_rows(jor3, jor4) %>%
  mutate(q20112 = recode(q20112,
                         "No trust at all" = "I absolutely do not trust it" ,
                        "A great deal of trust" = "I trust it to a great extent" ,
                        "Not very much trust" = "I trust it to a limited extent",
                        "Quite a lot of trust" = "I trust it to a medium extent")) %>%
  mutate(q20112 = fct_relevel(q20112, 
                              c("I trust it to a great extent",
                                "I trust it to a medium extent",
                                "I trust it to a limited extent",
                                "I absolutely do not trust it")))

## Plot
# Tunisia
ggplot(data = tun, aes(x = "", y = n, fill = q20112)) + 
  geom_bar(width = 1, stat = "identity", color = "white") +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), size = 3) +
  coord_polar("y", start = 0) +
  scale_fill_brewer(palette="Blues") +
  facet_grid(facets=. ~ year) + theme_bw() + 
  labs(title = "Attitude towards Islamist Parties in Tunisia",
       subtitle = "Before and After Anti-Terror Law Adoption in 2015",
       caption = "Source: Arab Barometer Wave III, IV") + 
  theme(legend.title = element_blank(),
        panel.grid  = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())

# Jordan
ggplot(data = jor, aes(x = "", y = n, fill = q20112)) + 
  geom_bar(width = 1, stat = "identity", color = "white") +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), size = 3) +
  coord_polar("y", start = 0) +
  scale_fill_brewer(palette="RdPu") +
  facet_grid(facets=. ~ year) + theme_bw() + 
  labs(title = "Attitude towards Islamist Parties in Jordan",
       subtitle = "Before and After Anti-Terror Law Adoption in 2015",
       caption = "Source: Arab Barometer Wave III, IV") + 
  theme(legend.title = element_blank(),
        panel.grid  = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
```

As for a preliminary stage, I graph how Tunisian and Jordan public responds to questionnaire regarding political Islamist parties, and compare how it changes once anti-terror law has been passed. 

In both countries, more people have expressed that they absolutely do not trust Islamist parties in the later period. Since the two waves of survey data contain different number of respondents and non-response (either refused to answer or do not know), the results may not be accurate. Although we do see an increase in the distrust group and decrease in the middle range (medium or limited trust), the group that expressed great trust also decreased. This is why just by looking at these graphs, one cannot conclude that there has been more polarization between groups. 


### 2. Models
#### a-b) Preprocess predictors

For the analysis, I will only look at Tunisian case. The below questionnaires are my predictors: 1) political attitude towards Political Islam and 2) Media Exposure. People who are more interested in politics and exposed to the media will have stronger opinion towards Islamist groups after the adoption of the law. (In general, people would be less interested and aware of the law unless they are exposed to the news.)

1) Political attitude towards political Islam

- q20112 : How much trust you have in the Muslim Brotherhood. (A great deal of trust - Quite a lot of trust - Not very much trust - No trust at all) - Ordinal
- q6062 : Your country is better off if religious people hold public positions in the state. (Strongly Agree - Agree - Disagree - Strongly Disagree) - Ordinal


2) Media Exposure

- q404 : In general, to what extent are you interested in politics? (Not interested at all, Somewhat interested, Interested, Very interested)
- q409 : On average, how often do you use the internet? (I do not use the internet, Less than once a week, Once a week, Several times a week, I am online almost all day, Daily)

As for measurement, I use scaling method for ordinal variables, by replacing each ordinal categorical variable with $$\frac{i-1/2}{M}$$. In this way, all questions that may contain 4 or 6 responses will be scaled out. 

PC1 and PC2 explains 81.97 percent of the variation.

```{r}
religion_tun_4 <- abv4 %>%
  filter(country == "Tunisia") %>%
  select(q20112, q6062, q404, q409) %>%
  filter(!q20112 %in% c("Decline to answer (Do not read)", 
                        "Don't know (Do not read)"),
         !q6062 %in% c("Decline to answer (Do not read)", 
                        "Don't know (Do not read)"),
         !q404 %in% c("Decline to answer (Do not read)", 
                        "Don't know (Do not read)"),
         !q409 %in% c("Decline to answer (Do not read)", 
                        "Don't know (Do not read)")) %>%
  mutate(q20112 = recode(q20112,
                         "No trust at all" = 0.125 ,
                         "Not very much trust" = 0.375,
                         "Quite a lot of trust" = 0.625,
                         "A great deal of trust" = 0.875),
         q6062 = recode(q6062,
                         "I strongly disagree" = 0.125 ,
                         "I disagree" = 0.375,
                         "I agree" = 0.625,
                         "I strongly agree" = 0.875),
         q404 = recode(q404,
                         "Not interested at all" = 0.125 ,
                         "Somewhat interested" = 0.375,
                         "Interested" = 0.625,
                         "Very interested" = 0.875),
         q409 = recode(q404,
                         "I do not use the internet" = 0.083 ,
                         "Less than once a week" = 0.25,
                         "Once a week" = 0.417,
                         "Several times a week" = 0.583,
                         "I am online almost all day" = 0.75,
                         "Daily" = 0.91)) 

rel_cov <- cov(religion_tun_4)
eigen_rel <- eigen(rel_cov)
eigen_rel

# apply PCA
principle_tunisia <- religion_tun_4 %>%
  prcomp()
summary(principle_tunisia)

tunisia_pca <- bind_cols(religion_tun_4, as_tibble(principle_tunisia$x))


## plot 
ggplot() + 
  geom_point(data = tunisia_pca, aes(PC1, PC2)) +
  labs(title = "PC1 and PC2 for Tunisia") + coord_equal() + theme_minimal()
```

### 3. Estimation 
#### a) Since I have two general predictors, I set the initial cluster number as 4.

```{r}
# set a seed because the clusters are not deterministic
set.seed(2020)

# predict four clusters
tunisia_kmeans4 <- kmeans(religion_tun_4,
                            centers = 4,
                            nstart = 100)

tidy(tunisia_kmeans4) %>% 
  knitr::kable(digits = 2)
```


#### b) The optimal number of cluster turns out to be 6. However, intuitively we can say that 2 is enough. Two clusters explain as well, but with smaller number of clusters. However, if we use two clusters, the graph turns out to be quite simple, so here I provide each cluster groups. 

```{r}
# optimal cluster
fviz_nbclust(religion_tun_4, FUN = kmeans, method = "silhouette")

tunisia_kmeans2 <- kmeans(religion_tun_4,
                            centers = 2,
                            nstart = 100)
tunisia_kmeans6 <- kmeans(religion_tun_4,
                            centers = 6,
                            nstart = 100)

# cluster
tunisia_clusters <- bind_cols(
  select(tunisia_pca, PC1, PC2), 
  cluster2 = tunisia_kmeans2$cluster,
  cluster6 = tunisia_kmeans6$cluster
)

# plot
cluster6 <- ggplot() + 
  geom_point(data = tunisia_clusters, 
             aes(PC1, PC2, color = factor(cluster6), 
                 shape = factor(cluster6)), alpha = 0.5) +
  labs(title = "K-Means with K=6 and PCA",
       x = "PC1 (0.55 of Variation)",
       y = "PC2 (0.27 of Variation)") + theme_minimal() + guides(text = NULL)

cluster2 <- ggplot() + 
  geom_point(data = tunisia_clusters, 
             aes(PC1, PC2, color = factor(cluster2), 
                 shape = factor(cluster2)), alpha = 0.5) +
  labs(title = "K-Means with K=2 and PCA",
       x = "PC1 (0.55 of Variation)",
       y = "PC2 (0.27 of Variation)") + theme_minimal() + guides(text = NULL)


grid.arrange(cluster2, cluster6, nrow = 2)
```


### 4. Interpretation

Because the data is survey data, it's a little difficult to intuitively interpret the results. There seems to be a slightly postive relationship between PC1 and PC2 and clusters seem to divide within negative and positive values in PC1 when there are only two clusters, the same for PC2 when having more clusters. 

Having more clusters may explain more variation but with more clusters, it becomes more difficult to explain in a straighforward manner. One confusion I have at this point is what each PCAs explain in terms of the predictors or questionnaires I use. Another unclear point is if different specification means models with different number of clusters, predictors or algorithms. 

I could further improve the analysis by having a basic covariate (e.g. Democrat/Republican divide) other than the predictors, or use the q20112 as the basic covariate and use other predictors to create clusters. 




